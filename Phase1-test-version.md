# 🎯 Phase 1 - 测试版本功能说明

> **当前版本**: Phase 1 Beta - 完整赛马系统 + NFT 拥有权系统 + 自动化机器人  
> **开发状态**: ✅ 已完成并部署到 Aptos Testnet  
> **测试网络**: Aptos Testnet  
> **合约地址**: `0x1b5957414b227d9fedd6015c2b53e648166cc552b6b9747a68c496c5b45086f7::equinox_v3`

## 📋 已实现功能概览

### ✅ 核心功能已完成

#### 1. 基础赛马系统
- **创建比赛**: 玩家可以创建新的“普通模式”赛马比赛。
- **快速匹配**: 支持玩家加入“快速匹配”队列，系统自动创建比赛。
- **加入比赛**: 支持多名玩家参与同一场比赛。
- **实时比赛**: 回合制比赛进程，支持实时状态更新。
- **比赛结果**: 完整的排名和结果展示系统。
- **自动化推进**: 后端机器人自动推进比赛进程，无需手动干预。

#### 2. 马匹NFT拥有权系统 🆕
- **马匹铸造**: 玩家可以支付 `0.02 APT` 铸造自己的独特马匹NFT。
- **属性自定义**: 可自定义马匹的名称、速度(30-80)、耐力(30-80)、地形偏好(草地/泥地/全天候)、颜色等属性。
- **马匹管理**: 完整的马匹库系统，用于查看和管理拥有的所有马匹。
- **NFT参赛**: 使用自己拥有的NFT马匹参加比赛。
- **马匹验证**: 系统验证马匹所有权，确保只有拥有者可以使用。

#### 3. 投注系统
- **赛前投注**: 支持对不同马匹进行投注，最低投注额 `0.005 APT`。
- **投注池**: 自动汇集所有投注金额。
- **奖励分发**: 根据比赛结果自动分发奖励。
  - **参赛者奖池**: 占总投注额的 40%，按名次分配（第1名50%，第2名30%，第3名20%）。
  - **投注奖池**: 占总投注额的 60%，按比例分配给投注给获胜马匹的玩家。

#### 4. 双模式支持
- **经典模式**: 使用系统预设的马匹参赛。
- **NFT模式**: 使用自己拥有的NFT马匹参赛。
- **无缝切换**: 用户可以在两种模式间自由选择。

#### 5. 自动化机器人系统 🆕
- **比赛推进**: 自动调用 `advance_race` 函数推进比赛进程。
- **快速比赛执行**: 自动执行到期的快速比赛。
- **智能监控**: 持续监控所有活跃比赛状态。
- **防冲突机制**: 内置冷却时间防止重复操作。

## 🎮 用户体验流程

### 新用户完整体验路径

1. **连接钱包** 
   - 支持 Petra 等主流 Aptos 钱包。
   - 一键连接，自动检测网络。

2. **铸造第一匹马**
   - 进入“马匹管理” (Horse Stable) 标签页。
   - 点击“铸造新马匹” (Mint New Horse)。
   - 自定义马匹属性：
     - 命名马匹
     - 设置速度值 (30-80)
     - 设置耐力值 (30-80)  
     - 选择地形偏好（草地/泥地/全天候）
     - 选择马匹颜色

3. **参与比赛**
   - 切换到“大厅” (Lobby) 标签页。
   - **选择模式**:
     - **快速匹配**: 加入等待队列，系统自动开始比赛。
     - **普通模式**: 创建新比赛或加入现有比赛。
   - **选择马匹**:
     - 在“NFT模式”下，选择自己的马匹参赛。
     - 在“经典模式”下，选择系统提供的马匹。
   - 等待其他玩家加入。

4. **观看比赛**
   - 实时查看比赛进程和马匹位置变化。
   - 查看比赛日志和事件。
   - 比赛自动推进，无需手动操作。

5. **查看结果**
   - 比赛结束后查看最终排名。
   - 如有投注，查看奖励分发情况。

## 🛠️ 技术实现详情

### Move 智能合约层 (`equinox.move`)

#### 主要数据结构
```rust
// 马匹NFT，作为资源存储在玩家账户下
struct HorseNFT has key, copy, drop {
    id: u64,
    name: String,
    speed: u64,
    endurance: u64,
    terrain_type: u8,
    color: String,
    owner: address,
    created_time: u64,
}

// 比赛状态
struct Race has store, copy {
    race_id: u64,
    creator: address,
    race_type: u8, // 0: Normal, 1: Quick
    track: RaceTrack,
    horses: vector<Horse>,
    entries: vector<RaceEntry>,
    bets: vector<Bet>,
    total_bet_pool: u64,
    entry_fee_pool: u64,
    race_started: bool,
    race_finished: bool,
    current_round: u64,
    max_players: u64,
    created_time: u64,
    start_time: Option<u64>,
    betting_end_time: Option<u64>,
    randomness_seed: u64,
}

// 快速匹配队列
struct QuickMatchQueue has store {
    waiting_players: vector<address>,
    current_race_id: Option<u64>,
    last_queue_time: u64,
}
```

#### 主要合约函数
- `initialize_player()`: 为新玩家初始化必要的账户资源。
- `mint_horse()`: 铸造新的马匹NFT。
- `create_normal_race()`: 创建一个普通比赛房间（使用随机性API）。
- `join_quick_match()`: 加入快速匹配队列。
- `join_race_with_horse()`: 使用经典马匹加入比赛。
- `join_race_with_nft()`: 使用NFT马匹加入比赛。
- `place_bet()`: 下注。
- `start_race()`: （由创建者）手动开始普通比赛。
- `execute_quick_race()`: （由任何人）在倒计时结束后触发快速比赛开始。
- `advance_race()`: 推进比赛进入下一回合（使用随机性API，主要由后端机器人调用）。

#### 随机性API集成 🆕
- **安全随机性**: 使用 Aptos 官方随机性API (`#[randomness]` 属性)。
- **防攻击**: 实现了防测试-中止攻击机制。
- **私有函数**: 随机性函数为私有入口函数，符合安全要求。

### 前端实现层 (Next.js + TypeScript)

#### 主要组件
- **`RaceTrack.tsx`**: 赛道和比赛可视化界面。
- **`HorseSelection.tsx`**: 经典模式下的马匹选择器。
- **`NFTHorseSelection.tsx`**: NFT模式下的马匹选择器。
- **`HorseStable.tsx`**: 马匹管理主界面，包括铸造功能。
- **`BettingPanel.tsx`**: 投注面板。
- **`RaceControls.tsx`**: 包含开始、加入比赛等控制按钮的组件。
- **`WalletConnector.tsx`**: Aptos钱包连接器。

#### 主要 Hooks
- **`useRace.ts`**: 管理单个比赛的状态，包括获取比赛数据和发送交易。
- **`usePlayerHorses.ts`**: 管理玩家拥有的马匹NFT列表，处理铸造和获取详情。

#### 技术特性
- **实时更新**: 交易完成后自动刷新UI状态。
- **错误处理**: 完善的错误提示和用户反馈。
- **响应式设计**: 支持多种设备尺寸。

### 后端机器人系统 🆕

#### 核心功能
- **自动比赛推进**: 监控并推进所有活跃比赛。
- **快速比赛执行**: 自动执行到期的快速比赛。
- **智能冷却**: 防止重复操作的内置冷却机制。
- **日志记录**: 完整的操作日志和错误追踪。

#### 技术实现
- **Python异步**: 使用 `asyncio` 实现高效并发处理。
- **Aptos SDK**: 集成官方SDK进行区块链交互。
- **环境配置**: 支持多环境配置和密钥管理。
- **错误恢复**: 自动错误处理和重试机制。

## 🎯 游戏平衡设计

### 马匹属性约束
- **速度范围**: 30-80，影响每回合移动距离。
- **耐力范围**: 30-80，影响持续作战能力和体力消耗。
- **地形加成**: 
  - 草地专精: 在晴天的草地赛道有显著加成。
  - 泥地专精: 在雨天的泥地赛道有显著加成。
  - 全天候: 在任何条件下都有稳定的小幅加成。

### 比赛机制
- **多因素影响**: 基础属性 + 随机因素 + 地形/天气匹配 + 体力消耗。
- **策略深度**: 不同属性配置在不同条件下有不同表现。
- **运气成分**: 适量的随机性保证比赛的不可预测性。
- **体力系统**: 每回合消耗体力，影响后续表现。

### 经济平衡
- **铸造成本**: 0.02 APT（约 $0.02）
- **参赛费用**: 0.01 APT（约 $0.01）
- **最低投注**: 0.005 APT（约 $0.005）
- **奖励分配**: 40% 参赛者，60% 投注者

## 🧪 测试状态

### ✅ 已通过测试
- **编译测试**: 
  - ✅ Next.js 前端编译通过 (`npm run build`)。
  - ✅ Move 合约编译成功 (`aptos move compile`)。
  - ✅ 合约部署成功到 Aptos Testnet。
- **功能测试**:
  - ✅ 钱包连接正常。
  - ✅ 马匹铸造流程完整。
  - ✅ NFT参赛功能正常。
  - ✅ 经典模式参赛功能正常。
  - ✅ 比赛流程（创建、加入、开始、进行、结束）完整。
  - ✅ 投注功能正常。
  - ✅ 随机性API集成正常。
  - ✅ 机器人自动化功能正常。
- **集成测试**:
  - ✅ 前后端合约交互正常。
  - ✅ 机器人与合约交互正常。
  - ✅ 多用户同时操作正常。

### 🔄 待测试项目
- **压力测试**: 大量马匹和并发比赛下的系统性能。
- **边界测试**: 极端参数输入（如最低/最高属性的马匹）。
- **网络测试**: 在Aptos Testnet上的长时间运行稳定性和Gas费用优化。
- **机器人稳定性**: 长时间运行和错误恢复能力。

## 🚧 已知限制

### 当前版本限制
1. **简化NFT实现**: NFT是作为 `resource` 直接存储在用户账户下，而不是使用标准的数字资产（Digital Asset）或Token Object模型。这简化了实现，但限制了在标准市场上的互操作性。
2. **无实际代币**: 投注和奖励使用 `AptosCoin`，未集成项目自己的ERC20代币。
3. **单一赛道**: 赛道长度固定，地形和天气随机生成，但视觉上只有一种基础赛道。
4. **机器人依赖**: 比赛推进依赖后端机器人，需要确保机器人稳定运行。

### 设计书功能缺失
- ❌ 风土系统 (OriginRegion)
- ❌ 马匹性格和情绪系统
- ❌ 繁殖系统
- ❌ 训练和技能点系统
- ❌ 装备和消耗品
- ❌ 土地和俱乐部系统

## 🔮 Phase 2 计划

### 下一阶段重点功能
1. **风土系统实现**
   - 引入多个不同的地理区域。
   - 区域特色能力加成。
   - 捕捉地点影响马匹属性。

2. **马匹性格系统**
   - 引入多种基础性格类型。
   - 性格影响比赛中的随机事件和表现。
   - 引入动态情绪状态。

3. **增强的比赛体验**
   - 多样化的赛道视觉效果和类型。
   - 更丰富的比赛事件和策略选择。

4. **去中心化推进**
   - 实现无需机器人的比赛推进机制。
   - 玩家驱动的比赛进程。

## 💡 测试建议

### 推荐测试场景
1. **单人测试**:
   - 铸造 3-5 匹不同属性的马匹。
   - 创建"普通比赛"，并使用不同马匹参赛，观察结果差异。
   - 加入"快速匹配"，测试自动匹配和比赛流程。
   - 测试投注系统。

2. **多人测试**:
   - 邀请朋友一起测试。
   - 创建多人"普通比赛"。
   - 测试投注系统和奖励分配的准确性。
   - 观察机器人自动推进比赛。

3. **机器人测试**:
   - 启动比赛后观察机器人是否自动推进。
   - 测试快速比赛的自动执行。
   - 验证比赛完成后的奖励分配。

### 反馈收集重点
- 用户体验流程是否顺畅？
- 马匹属性设计是否平衡？
- 界面操作是否直观？
- 比赛观看体验如何？
- 机器人运行是否稳定？
- 发现的 Bug 和改进建议。

## 🚀 部署和运行

### 当前部署状态
- **合约**: 已部署到 Aptos Testnet (`equinox_v3`)
- **前端**: 已部署到 Vercel
- **机器人**: 可在本地或云端运行

### 机器人部署选项
1. **本地运行**: 适合开发和测试
2. **云平台**: Railway, Render, Heroku 等
3. **VPS**: DigitalOcean, AWS EC2 等

### 环境要求
- **Python 3.8+**: 机器人运行环境
- **Aptos SDK**: 区块链交互
- **环境变量**: 私钥、合约地址、节点URL等

---

**Phase 1 版本已实现完整的赛马系统，包括NFT铸造、比赛机制、投注系统和自动化机器人。系统稳定运行在 Aptos Testnet 上，为后续复杂系统奠定了坚实基础。期待您的测试反馈！** 🚀
